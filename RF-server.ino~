/*
 * This code is meant to be run on an ESP32
 * 
 */

#include <RFM69.h>
#include <SPI.h>

// Addresses for this node. CHANGE THESE FOR EACH NODE!

#define NETWORKID     0   // Must be the same for all nodes
#define MYNODEID      1   // ID for the server is 1

// RFM69 frequency
#define FREQUENCY RF69_433MHZ

// AES encryption (or not):
#define ENCRYPT       false // Set to "true" to use encryption
#define ENCRYPTKEY    "TOPSECRETPASSWRD" // Use the same 16-byte key on all nodes

// Requests ACK or note
#define USEACK true

// Packet sent/received indicator LED (optional):
#define PIN_LED 8
#define PIN_SLAVESELECT 7
#define PIN_INTERUPT 2

// Create a library object for our RFM69HCW module:
RFM69 radio(PIN_SLAVESELECT, PIN_INTERUPT, true);

void setup()
{
  Serial.begin(9600);
  Serial.println(F("Node number "));
  Serial.println(MYNODEID,DEC);

  Serial.print(F("SCK: "));
  Serial.println(SCK);
  Serial.print(F("MOSI: "));
  Serial.println(MOSI);
  Serial.print(F("MISO: "));
  Serial.println(MISO);
  Serial.print(F("SS: "));
  Serial.println(SS);

  // Set up the indicator LED (optional):
  pinMode(PIN_LED,OUTPUT);
  digitalWrite(PIN_LED,LOW);

  // Initialize the RFM69HCW:
  radio.initialize(FREQUENCY, MYNODEID, NETWORKID);
  radio.setHighPower(); // Always use this for RFM69HCW

  // Turn on encryption if desired:
  if (ENCRYPT)
    radio.encrypt(ENCRYPTKEY);

  Serial.print(F("Frequency: "));
  Serial.println(radio.getFrequency());
}

void loop()
{
  // Receiving data
  if (radio.receiveDone())
  {
    // Print out the information:
    Serial.print(F("Received from node "));
    Serial.println(radio.SENDERID, DEC);

    // Printing the message  
    for (byte i = 0; i < radio.DATALEN; i++)
      Serial.print((char)radio.DATA[i]);

    // RSSI
    Serial.print(F("], RSSI "));
    Serial.println(radio.RSSI);

    // Send an ACK if requested.
    if (radio.ACKRequested())
    {
      radio.sendACK();
      Serial.println(F("ACK sent"));
    }
    Blink(PIN_LED,10);
  }
}

void Blink(byte PIN, int DELAY_MS)
// Blink an LED for a given number of ms
{
  digitalWrite(PIN,HIGH);
  delay(DELAY_MS);
  digitalWrite(PIN,LOW);
  delay(DELAY_MS);
}
